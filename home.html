<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Niphkeyz</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 520px;
      margin: 30px auto;
      background: #111;
      border-radius: 18px;
      padding: 35px;
      border: 1px solid #333;
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
    }
    .logo {
      font-family: Georgia, serif;
      font-size: 52px;
      font-style: italic;
      text-align: center;
      background: linear-gradient(45deg, #3897f0, #9b59b6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .welcome {
      text-align: center;
      font-size: 26px;
      margin: 20px 0;
      font-weight: 600;
    }
    .section {
      margin: 35px 0;
      padding: 25px;
      background: #1a1a1a;
      border-radius: 14px;
      border: 1px solid #333;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 18px;
      color: #3897f0;
      text-align: center;
    }
    input {
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      background: #222;
      border: 1px solid #444;
      border-radius: 12px;
      color: white;
      font-size: 16px;
    }
    input:focus {
      outline: none;
      border-color: #3897f0;
      box-shadow: 0 0 0 3px rgba(56,151,240,0.2);
    }
    button {
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    .shorten-btn {
      width: 100%;
      background: rgb(0, 0, 255);
      color: white;
      font-size: 16px;
    }
    .shorten-btn:hover { background: #1877f0; }
    .result {
      background: #000;
      padding: 16px;
      border-radius: 12px;
      margin: 15px 0;
      border: 2px solid #3897f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .short-link {
      font-weight: bold;
      color: #3897f0;
    }
    .copy-btn, .visit-btn {
      padding: 8px 16px;
      font-size: 14px;
    }
    .copy-btn { background: #27ae60; }
    .visit-btn { background: #8e44ad; }
    .links-list {
      margin-top: 20px;
    }
    .link-item {
      background: #222;
      padding: 14px;
      border-radius: 10px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .logout {
      display: block;
      margin: 40px auto 0;
      background: #e74c3c;
      width: fit-content;
      padding: 14px 32px;
      font-size: 16px;
    }
    .logout:hover { background: #c0392b; }
    .count { color: #3897f0; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="logo">Niphkeyz</h1>
    <div class="welcome" id="welcomeMessage"></div>

    <!-- URL Shortener Section -->
    <div class="section">
      <h2>URL Shortener</h2>
      <input type="url" id="longUrl" placeholder="Paste your long URL here (e.g. https://youtube.com/...)" required>
      <button class="shorten-btn" onclick="shortenUrl()">Shorten URL</button>

      <div id="result"></div>
    </div>

    <!-- User's Short Links History -->
    <div class="section">
      <h2>Your Short Links (<span class="count" id="linkCount">0</span>)</h2>
      <div id="linksList" class="links-list">
        <i>Shorten a URL to see it here!</i>
      </div>
    </div>

    <button class="logout" onclick="logout()">Log Out</button>
  </div>

  <script>
  // LOGIN CHECK
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if (!currentUser) {
    alert("please log in first");
    window.location.replace("index.html");
  } else {
    document.getElementById("welcomeMessage").innerHTML =
      `Welcome back, <strong>${currentUser.firstName} ${currentUser.lastName}</strong>!`;
  }

  function logout() {
    localStorage.removeItem("currentUser");
    alert("Logged out successfully!");
    window.location.replace("index.html");
  }

  // URL SHORTENER LOGIC
  // const DOMAIN = "https://niphkeyz.co/";
  const DOMAIN = "http://127.0.0.1:5501/";

  function generateCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  // Shorten URL and save
  function shortenUrl() {
    const longUrl = document.getElementById("longUrl").value.trim();

    // if (!longUrl || !longUrl.match(/^https?:\/\//i)) {
    //   alert("Please enter a valid URL starting with http:// or https://");
    //   return;
    // }

    const code = generateCode();
    // Use redirect.html with code parameter
    const shortUrl = DOMAIN + "redirect.html?code=" + code;

    // Load all saved links
    let allLinks = JSON.parse(localStorage.getItem("shortLinks") || "{}");
    // allLinks[currentUser.email] = allLinks[currentUser.email] || [];

    // Save new link
    allLinks[currentUser.email] = [{
      code,
      short: shortUrl,
      long: longUrl,
      date: new Date().toLocaleString()
    }];

    // Save back to localStorage
    localStorage.setItem("shortLinks", JSON.stringify(allLinks));

    // Show result
    document.getElementById("result").innerHTML = `
      <div class="result">
        <div>
          <div class="short-link">${shortUrl}</div>
          <small>→ ${longUrl.substring(0,50)}${longUrl.length > 50 ? "..." : ""}</small>
        </div>
        <div>
          <button class="copy-btn" onclick="copyText('${shortUrl}')">Copy</button>
          <button class="visit-btn" onclick="window.open('${longUrl}')">Visit</button>
        </div>
      </div>
    `;

    document.getElementById("longUrl").value = "";
    loadLinks();
  }

  // copy function
  function copyText(text) {
    navigator.clipboard.writeText(text.trim())
      .then(() => {
        alert("Copied!");
      })
      .catch(err => {
        console.error("Copy failed", err);
      });
  }

  // Load user's saved links
  function loadLinks() {
    const allLinks = JSON.parse(localStorage.getItem("shortLinks") || "{}");
    const userLinks = allLinks[currentUser.email] || [];

    document.getElementById("linkCount").textContent = userLinks.length;

    if (userLinks.length === 0) {
      document.getElementById("linksList").innerHTML = "<i>No links yet. Shorten one above!</i>";
      return;
    }

    document.getElementById("linksList").innerHTML = userLinks.map(link => `
      <div class="link-item">
        <div>
          <div class="short-link">${link.short}</div>
          <small>→ ${link.long.substring(0,45)}${link.long.length > 45 ? "..." : ""}</small><br>
          <small style="color:#777;">${link.date}</small>
        </div>
        <div>
          <button class="copy-btn" onclick="copyText('${link.short}')">Copy</button>
        </div>
      </div>
    `).join("");
  }

  loadLinks();
</script>

</body>
</html>
